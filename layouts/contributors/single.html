{{/* layouts/contributors/single.html */}}
{{ define "main" }}
{{ partial "page-header" . }}

<section class="section pt-6">
  <div class="container">
    <div class="row justify-center">
      {{/* Contributor Details Column (Left Sidebar) */}}
      <aside class="lg:col-4 mb-8">
        <div class="sticky top-24">
          <div class="p-6 rounded-lg bg-theme-light dark:bg-darkmode-theme-light shadow-lg">
            {{ if .Params.image }}
            {{ partial "image" (dict "Src" .Params.image "Context" . "Alt" .Title "Class" "mx-auto mb-6 rounded-full" "Size" "150x150" "Command" "Fill") }}
            {{ end }}
            <h2 class="text-3xl font-bold text-center mb-3">{{ .Title }}</h2>
            {{ if .Params.social }}
            <ul class="contributor-socials flex justify-center space-x-3 mb-6">
              {{ range .Params.social }}
              <li>
                <a href="{{ .link | safeURL }}" target="_blank" rel="noopener noreferrer" aria-label="{{ .title }}" class="text-xl">
                  {{ $iconData := partial "helpers/parse-fa-class.html" .icon }}
                  {{ partial "icon.html" (dict "style" $iconData.style "name" $iconData.name "class" "") }}
                </a>
              </li>
              {{ end }}
            </ul>
            {{ end }}
            <div class="content prose prose-sm dark:prose-invert max-w-none dark:text-darkmode-light text-text">
              {{ .Content }}
            </div>
          </div>
        </div>
      </aside>

      {{/* Contributions Column (Main Content) */}}
      <div class="lg:col-8">
        <h2 class="text-3xl font-semibold mb-8 text-center lg:text-left">Contributions</h2>

        {{ $contributorName := .Title }}
        
        {{/* --- Step 1: Collect all relevant contribution objects {Page, Year, Role} --- */}}
        {{ $contributions := slice }}
        {{ $allRelevantPages := where site.RegularPages "Type" "in" (slice "blog" "workshops" "student-talks" "hacking-hours" "initiatives") }}

        {{ range $page := $allRelevantPages }}
           {{ $isMatch := false }}
           {{ $role := "" }}
           {{ $year := $page.Date.Format "2006" }}

           {{/* Check Active Contributors (Granular Year override) */}}
           {{ if $page.Params.active_contributors }}
              {{ range $yearBlock := $page.Params.active_contributors }}
                 {{ if in $yearBlock.names $contributorName }}
                    {{ $contributions = $contributions | append (dict "Page" $page "Year" (string $yearBlock.year) "Role" "Contributor") }}
                    {{ $isMatch = true }}
                 {{ end }}
              {{ end }}
           {{ end }}

           {{/* If no granular match, check standard fields */}}
           {{ if not $isMatch }}
              {{/* Authors */}}
              {{ if and $page.Params.author (in $page.Params.author $contributorName) }}
                 {{ $contributions = $contributions | append (dict "Page" $page "Year" $year "Role" "Author") }}
                 {{ $isMatch = true }}
              {{ end }}
              
              {{/* Credits */}}
              {{ if and (not $isMatch) $page.Params.production_credits }}
                 {{ range $page.Params.production_credits }}
                    {{ if eq .name $contributorName }}
                       {{ $contributions = $contributions | append (dict "Page" $page "Year" $year "Role" .role) }}
                       {{ $isMatch = true }}
                    {{ end }}
                 {{ end }}
              {{ end }}
           {{ end }}
        {{ end }}

        {{/* --- Step 2: Separate Initiatives --- */}}
        {{ $initiativeContributions := slice }}
        {{ $timelineContributions := slice }}

        {{ range $c := $contributions }}
           {{ if eq $c.Page.Type "initiatives" }}
              {{/* Deduplicate initiatives for the top card view (show once even if multiple years) */}}
              {{ $found := false }}
              {{ range $i := $initiativeContributions }}{{ if eq $i.Page $c.Page }}{{ $found = true }}{{ end }}{{ end }}
              {{ if not $found }}{{ $initiativeContributions = $initiativeContributions | append $c }}{{ end }}
              
              {{/* Also add to timeline? Usually initiatives are kept separate at top, but if they have specific years now, maybe timeline is good? 
                 Let's keep the existing design: Initiatives cards at top, everything else in timeline. */}}
           {{ else }}
              {{ $timelineContributions = $timelineContributions | append $c }}
           {{ end }}
        {{ end }}

        {{/* Render Initiatives */}}
        {{ if $initiativeContributions }}
        <div class="mb-12">
          <h3 class="text-2xl font-semibold mb-5 border-b-2 border-primary dark:border-darkmode-primary pb-2">Initiatives</h3>
          <div class="grid md:grid-cols-2 gap-6">
            {{ range $initiativeContributions }}
            <div>
              {{ partial "components/initiative-card.html" .Page }}
            </div>
            {{ end }}
          </div>
        </div>
        {{ end }}

        {{/* Render Timeline */}}
        {{ $sortedTimelineItems := sort $timelineContributions "Year" "desc" }}

        {{ if $sortedTimelineItems }}
        <div class="mb-10">
          <h3 class="text-2xl font-semibold mb-6 {{ if $initiativeContributions }}border-t-2 border-border dark:border-darkmode-border pt-8{{ end }}">Activity Timeline</h3>
          <div class="contributor-timeline">
            {{ $currentYear := "" }}
            {{ range $item := $sortedTimelineItems }}
            
            {{ if ne $item.Year $currentYear }}
            <div class="timeline-year">
              <span>{{ $item.Year }}</span>
            </div>
            {{ $currentYear = $item.Year }}
            {{ end }}
            
            <div class="timeline-item">
              <div class="timeline-item-content">
                <div class="flex justify-between items-start gap-4">
                  {{/* Left side: Title and Date */}}
                  <div>
                    <h4 class="text-xl font-semibold mb-1">
                      <a href="{{ $item.Page.RelPermalink }}" class="text-dark dark:text-darkmode-dark hover:text-primary dark:hover:text-darkmode-primary">{{ $item.Page.Title }}</a>
                    </h4>
                    
                    {{/* For standard posts, show full date. For annual initiatives, maybe just year or "Active 202X"? 
                       Since we are in the timeline view, let's stick to standard date formatting if available, or just generic if it's an override. */}}
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                       {{ if eq $item.Role "Contributor" }}
                          Active in {{ $item.Year }}
                       {{ else }}
                          {{ $item.Page.Date.Format "January 2" }}
                       {{ end }}
                    </p>

                    {{ if and (ne $item.Role "Author") (ne $item.Role "Contributor") }}
                    <p class="text-xs text-primary dark:text-darkmode-primary font-medium mt-1">Role: {{ $item.Role }}</p>
                    {{ end }}
                  </div>
                  {{/* Right side: Badge */}}
                  <span class="timeline-item-badge flex-shrink-0">
                      {{ $item.Page.Type | default $item.Page.Section | humanize | title }}
                    </span>
                </div>
                {{ if $item.Page.Description }}
                <p class="text-gray-600 dark:text-gray-400 mt-3 text-sm">{{ $item.Page.Description }}</p>
                {{ end }}
              </div>
            </div>
            {{ end }}
          </div>
        </div>
        {{ end }}

        {{ if not (or $initiativeContributions $sortedTimelineItems) }}
        <div class="p-6 rounded bg-theme-light dark:bg-darkmode-theme-light shadow text-center">
          <p class="text-lg text-gray-600 dark:text-gray-400">No specific contributions found for this individual.</p>
        </div>
        {{ end }}

      </div>
    </div>
  </div>
</section>
{{ end }}
